@extends("shared/layout.html")
@require(post, sub, is_saved, subInfo, pollData, commentform, comments, postmeta, subMods, highlight, content_history, title_history)
@import "sub/postcomments.html" as pcomm
@import "sub/postpoll.html" as polls


@def title():
  @if (post['visibility'] == ''):
    @{post['title']} |\
  @else:
    @{_('[Deleted Post]')}
  @end

@end

@def meta_description():

    @if post['content']:
        <meta name="description" content="@{''.join(BeautifulSoup(markdown(post['content'])).findAll(text=True)).replace('\n', ' ')}"/>
    @else:
        <meta name="description" content="@{sub['title']}" />
    @end

    <meta property="og:site_name" content="@{config.site.lema}">
    <meta property="og:description" content="@{_('Posted in %(prefix)s/%(sub)s by %(username)s', prefix=config.site.sub_prefix, sub=sub['name'], username=post['user'])}">
    <meta property="og:title" content="@{post['title']}">
    @if post['thumbnail'] != '' and post['link'] != None:
    <meta property="og:image" content="@{thumbnail_url(post['thumbnail'])}">
    <meta property="og:ttl" content="600">
    <meta property="og:image:height" content="70">
    <meta property="og:image:width" content="70">
    @end
@end

@def sidebar():
<hr>
  <div class="author" style="padding:.5em;">
    @{_('Posted %(timeago)s by %(user)s', timeago='<time-ago datetime="' + post['posted'].isoformat() + 'Z"></time-ago>', user='<a class="authorlink" href="/u/' + post['user'] + '">' + post['user'] + '</a>' if post['userstatus'] != 10 else '<a class="authorlink deleted">' + _('[Deleted]') + '</a>')!!html}
    <br/>
    @if post['edited']:
      @{_('edited %(timeago)s', timeago='<time-ago datetime="' + post['edited'].isoformat() + 'Z"></time-ago>')!!html}<br/>
    @end
    @{_('Score: %(score)i <b>(+%(upvotes)i|-%(downvotes)i)</b>', score=post['score'], upvotes=post['upvotes'], downvotes=post['downvotes'])!!html}
  </div>
<hr>
  @include('shared/sidebar/sub.html')
@end

@def main():
<div class="wholepost">
  <div class="postbar post @{((post['visibility'] != '') and (post['visibility'] != 'none')) and 'deleted ' or ''}" pid="@{post['pid']}">
    <div class="misctainer">
      <div class="votebuttons">
        @if post['userstatus'] != 10 and (datetime.datetime.utcnow() - post['posted'].replace(tzinfo=None)) < datetime.timedelta(days=config.site.archive_post_after):
          <div title="@{_('Upvote')}" class="upvote @{(post.get('positive') == 1) and 'upvoted' or ''}" data-pid="@{post['pid']}" data-icon="upvote"></div>
          <div class="score">@{post['score']}</div>
          <div title="@{_('Downvote')}" class="downvote @{(post.get('positive') == 0) and 'downvoted' or ''}" data-pid="@{post['pid']}" data-icon="downvote"></div>
        @else:
          <div class="score archived">@{post['score']}</div>
        @end
      </div>
      <div class="thcontainer">
        <a class="title">
          <div class="thumbnail">
            @if post['thumbnail'] != '' and post['link'] != None:
              <img src="@{thumbnail_url(post['thumbnail'])}"/>
            @elif post['link'] != None:
              <span class="placeholder" data-icon="link"></span>
            @else:
              <span class="placeholder" data-icon="chat"></span>
            @end
          </div>
        </a>
      </div>
    </div>
    <div class="postinfo" id="postinfo" pid="@{post['pid']}">
      <div class="post-heading">
        @if post['nsfw'] or sub['nsfw']:
          <div class="nsfw" alt="@{_('Not safe for work')}">@{_('NSFW')}</div>
        @end

        @if post['flair']:
          <span class="postflair">@{post['flair']}</span>
        @end

        <span class="current history" data-id="0">
        @if post['link'] == None:
          <h1><a href="@{url_for('sub.view_post', sub=sub['name'], pid=post['pid'])}" class="title">
            @if (post['visibility'] == ''):
              @{post['title']}
            @elif (post['visibility'] == 'admin-self-del'):
              @{_('[Deleted by User]')} @{post['title']}
            @elif (post['visibility'] == 'mod-self-del'):
              @{_('[Deleted by User]')}
            @elif (post['visibility'] == 'mod-del'):
              @{_('[Deleted by Mod or Admin]')} @{post['title']}
            @elif (post['visibility'] == 'none'):
              @{_('[Deleted]')}
            @end
          </a></h1>
        @else:
          <h1><a rel="nofollow ugc @{(post['visibility'] == 'none') and 'noopener ' or ''}" href="@{(post['visibility'] != 'none') and post['link'] or '#'}" class="title">
            @if (post['visibility'] == ''):
              @{post['title']}
            @elif (post['visibility'] == 'admin-self-del'):
            @{_('[Deleted by User]')} @{post['title']}
            @elif (post['visibility'] == 'mod-self-del'):
              @{_('[Deleted by User]')}
            @elif (post['visibility'] == 'mod-del'):
              @{_('[Deleted by Mod or Admin]')} @{post['title']}
            @elif (post['visibility'] == 'none'):
              @{_('[Deleted]')}
            @end
          </a></h1>
          @if post['deleted'] == 0:
            <a href="/domain/@{func.getDomain(post['link'])}" class="domain">(@{func.getDomain(post['link'])})</a>
          @end
        @end
        </span>

        @if title_history and (post['visibility'] != 'none' and  post['visibility'] != 'mod-self-del'):
            @for count, old_title in enumerate(title_history):
              <span style="display:none;" class="old history" data-id="@{(count + 1)!!s}">
                @if post['link'] == None:
                  <h1><a href="@{url_for('sub.view_post', sub=sub['name'], pid=post['pid'])}" class="title">
                      @{old_title['title']}
                  </a></h1>
                @else:
                <h1><a rel="nofollow ugc @{(post['visibility'] == 'none') and 'noopener ' or ''}" href="@{(post['visibility'] != 'none') and post['link'] or '#'}" class="title">
                  @{old_title['title']}
                </a></h1>
                @end
              </span>
            @end
            <div class="title-history-controls">
              <button class="browse-history back" data-action="back">←</button>
              <button class="browse-history forward disabled" action="forward">→</button>
              <span class="history-meta">
                @{_('Viewing title history:')}
                  <span class="history-version">
                    1/@{1 + len(title_history)!!s}
                  </span>
              </span>
            </div>
        @end
      </div>
      <ul class="links" data-pid="@{post['pid']}">
        @if post['link']:
          @if func.getDomain(post['link']) in config.site.expando_sites:
            <li><div class="expando" data-pid="@{post['pid']}" data-t="lnk" data-link="@{post['link']}"><div class="icon expando-btn" data-icon="play"></div></div></li>
          @elif post['link'].lower().endswith(('.png', '.jpg', '.gif', '.tiff', '.bmp', '.jpeg')):
            <li><div class="expando" data-pid="@{post['pid']}" data-t="lnk" data-link="@{post['link']}"><div class="icon expando-btn" data-icon="image"></div></div></li>
          @elif post['link'].lower().endswith(('.mp4', '.webm', '.gifv')):
            <li><div class="expando" data-pid="@{post['pid']}" data-t="lnk" data-link="@{post['link']}"><div class="icon expando-btn" data-icon="play"></div></div></li>
          @end
        @end
        @if current_user.is_authenticated and post['deleted'] == 0:
          @if post['content']:
            <li><a class="post-source">source</a></li>
          @end

          @if is_saved:
            <li><a class="removesavedpost" data-pid="@{post['pid']}">@{_('unsave')}</a></li>
          @else:
            <li><a class="savepost" data-pid="@{post['pid']}">@{_('save')}</a></li>
          @end
          @if (subInfo.get('ucf', 0) == '1' and current_user.uid == post['uid']) or current_user.uid in subMods['all']:
            <li><a class="editflair">@{_('flair')}</a></li>
          @end
          @if post['uid'] == current_user.uid:
            @if post['ptype'] != 1:
              <li><a class="edit-post" data-pid="@{post['pid']}">@{_('edit')}</a></li>
            @end
            @if (datetime.datetime.utcnow() - post['posted'].replace(tzinfo=None)) < datetime.timedelta(seconds=config.site.title_edit_timeout):
              <li><a class="edit-title" data-pid="@{post['pid']}">@{_('edit title')}</a></li>
            @end
          @end

          @if post['uid'] == current_user.uid or current_user.is_admin() or current_user.uid in subMods['all']:
            <li id="delpostli"><a @{(post['uid'] == current_user.uid) and 'selfdel="true"' or ''} class="delete-post"> @{_('delete')} </a></li>

            @if not sub['nsfw']:
              @if not post['nsfw']:
                <li><a class="nsfw-post"> @{_('tag as nsfw')} </a></li>
              @else:
                <li><a class="nsfw-post"> @{_('remove nsfw')} </a></li>
              @end
            @end
          @end

          @if post['deleted'] == 0 and post['ptype'] == 3 and pollData['poll_open'] and (post['uid'] == current_user.uid or current_user.is_admin() or current_user.uid in subMods['all']):
              <li><a class="poll-close"> @{_('close poll')} </a></li>
          @end

          @if current_user.uid in subMods['all']:
            @if str(post['pid']) in subInfo['sticky']:
              <li><a class="stick-post">@{_('unstick')}</a></li>
            @else:
              <li><a class="stick-post">@{_('make sticky')}</a></li>
            @end

            @if str(post['pid']) == subInfo['wiki']:
              <li><a class="wiki-post">@{_('remove wiki')}</a></li>
            @else:
              <li><a class="wiki-post">@{_('make wiki')}</a></li>
            @end
            @if post['sub'] == 'announcements' and current_user.is_admin():
              @if not func.getAnnouncement() or func.getAnnouncement()['pid'] != post['pid']:
                <li><a class="announce-post">@{_('make announcement')}</a></li>
              @end
            @end
          @end
          <li><a data-ac="report" data-pid="@{post['pid']}" class="report-post">@{_('report')}</a></li>
        @end
        @if current_user.is_admin() and post['deleted'] == 2:
          <li id="delpostli"><a class="undelete-post"> @{_('un-delete')} </a></li>
        @end

      </ul>
    </div>
  </div>

  @if (subInfo.get('ucf', 0) == '1' and current_user.uid == post['uid']) or current_user.uid in subMods['all']:
    <div style="display:none;" id="postflairs">
      <span class="closemsg">×</span>
      @if post['flair']:
        <div>@{_('Current flair: <span class="postflair">%(flair)s</span>.', flair=e(post['flair']))} <a data-sub="@{post['sub']}" data-pid="@{post['pid']}" href="#" id="remove-flair">@{_('Remove')}</a>.</div>
      @end
      <h4>@{_('Select a new flair')}</h4>
      @for ll in func.getSubFlairs(post['sid']):
        <span class="selflair" data-sub="@{post['sub']}" data-flair="@{ll.xid}" data-pid="@{post['pid']}">@{ll.text}</span>
      @end
    </div>
  @end

  @if (post['ptype'] == 3) and (post['deleted'] == 0 or post['visibility'] == 'admin-self-del' or post['visibility'] == 'mod-del'):
    @{polls.renderPoll(pollData, postmeta, post)!!html}
  @end
  <div>
  @if post['content']:
  <div>
    @if post['deleted'] == 0:
      <span class="current history" data-id="0">
        <div id="postcontent" class="post-content-container">@{markdown(post['content'])!!html}</div>
      </span>
      <div id="post-source">@{post['content']}</div>
    @else:
      @if ((post['visibility'] == 'none') or (post['visibility'] == 'mod-self-del')):
        <div id="postcontent" class="post-content-container @{(post['visibility'] == 'mod-self-del') and 'deleted ' or ''}">
          @{_('[deleted]')}
        </div>
      @elif ((post['visibility'] == 'admin-self-del') or (post['visibility'] == 'mod-del')):
        <span class="current history" data-id="0">
          <div id="postcontent" class="post-content-container deleted">@{markdown(post['content'])!!html}</div>
        </span>
        <div id="post-source">@{post['content']}</div>
      @end
    @end
  </div>
  @elif not post['link']:
    <div id="postcontent" class="post-content-container"></div>
    <div id="post-source" class="post-content-container"></div>
  @end

  @if content_history and post['content'] and  (post['visibility'] != 'none' and  post['visibility'] != 'mod-self-del'):
      @for count, old_version in enumerate(content_history):
        <span style="display:none;" class="old history" data-id="@{(count + 1)!!s}">
          <div class="post-content-container @{(post['visibility'] != '') and 'deleted ' or ''}">@{markdown(old_version['content'])!!html}</div>
        </span>
      @end
      <div class="post-history-controls @{(post['visibility'] != '') and 'deleted ' or ''}"">
        <button class="browse-history back" data-action="back">←</button>
        <button class="browse-history forward disabled" action="forward">→</button>
        <span class="history-meta">
          @{_('Viewing edit history:')}
            <span class="history-version">
              1/@{1 + len(content_history)!!s}
            </span>
        </span>
      </div>
  @end
  </div>

  @if current_user.is_authenticated and post['deleted'] == 0 and not current_user.is_subban(sub):
  <form data-reset="true" data-redir="true" action="@{url_for('do.create_comment', pid=post['pid'])}" id="rcomm-0" class="comment-form ajaxform static pure-form">
    @{commentform.csrf_token()!!html}
    @{commentform.post(value=post['pid'])!!html}
    @{commentform.parent(value='0')!!html}
    <div class="markdown-editor" id="ncme">
      @{commentform.comment(id="comment2", placeholder=commentform.comment.label.text, rows="6")!!html}
    </div>
    <div class="div-error error alertbox"></div>
    <button type="submit" class="pure-button pure-button-primary btn-postcomment" data-cid="0" data-pid="@{post['pid']}">@{_('Submit comment')}</button>
    <button data-pvid="ncme" class="pure-button btn-preview">@{_('Preview')}</button>
    <div class="cmpreview canclose" style="display:none;">
      <h4>@{_('Comment preview')}</h4>
      <span class="closemsg">×</span>
      <div class="cpreview-content"></div>
    </div>
  </form>
  @end

  @if len(comments) == 0:
    <div class="comments"><h3 id="cmnts" data-cnt="0">@{_('No comments, yet...')}</h3></div>
  @else:
    <div class="comments">
      <h2 id="cmnts" data-cnt="@{post['comments']}"><a href="@{url_for('sub.view_post', sub=sub['name'], pid=post['pid'])}">@{_('%(comments)i comments', comments=post['comments'])}</a></h2>
      @{pcomm.renderComments(post, subInfo, subMods, comments, highlight)!!html}
    </div>
  @end


</div>

@end

@def pagefoot():
  @if not current_user.block_styles():
    <style>@{subInfo['stylesheet']!!html}</style>
  @end
@end
